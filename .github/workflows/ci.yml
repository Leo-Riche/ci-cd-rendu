name: CI (Integration)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      - name: Install dependencies
        run: |
          npm ci --prefix packages/server
          npm ci --prefix packages/client
      # Cache des modules
      - uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}

  # 2. Tests Unitaires & Coverage
  test-unit:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      # Restauration du cache (plus rapide que npm install)
      - uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
      
      - run: npm run test:coverage --prefix packages/server
      
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-artifact
          path: ./packages/server/coverage
          retention-days: 1

  # 3. Vérification du taux de couverture (PR uniquement)
  coverage-check:
    name: Coverage Check
    needs: test-unit
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: coverage-artifact
          path: ./pr-coverage
      - name: Check coverage >= 80%
        run: |
          node -e '
          const fs = require("fs");
          const path = "./pr-coverage/coverage-summary.json";
          if (!fs.existsSync(path)) { console.error("❌ coverage-summary.json not found"); process.exit(1); }
          const data = JSON.parse(fs.readFileSync(path, "utf8"));
          const pct = data.total.lines.pct;
          if (pct < 80) { console.error(`❌ Coverage ${pct}% is below 80%`); process.exit(1); }
          console.log("✅ Coverage threshold passed:", pct, "%");
          '

  # 4. Scan de sécurité NPM
  security-scan-npm:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
            node-version: "22.x"
      - run: npm audit --audit-level=high --prefix packages/server || true # Le "|| true" permet de ne pas bloquer si des failles mineures existent
      - run: npm audit --audit-level=high --prefix packages/client || true

  # 5. Build Docker TEST & Scan Trivy (Sans Push)
  docker-security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image (No Push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./packages/server/Dockerfile
          push: false
          tags: todo-test:latest
          outputs: type=docker,dest=/tmp/image.tar
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/image.tar
          format: 'table'
          exit-code: '1' # Fait échouer la CI si failles critiques
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'