name: CI-CD
on:
  pull_request:
    branches: [main]
    paths:
      - "packages/server/**"
      - ".github/workflows/ci.yml"
  push:
    tags:
      - "v*.*.*"

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: |
          npm ci --prefix packages/server
          npm ci --prefix packages/client
      # Cache des modules
      - uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-
  test:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-

      - name: Run tests (Server)
        # Exécution des tests sur packages/server (approche main)
        run: npm run test --prefix packages/server

  # 3. Exécution des tests unitaires et génération de la couverture
  test-unit:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      # Restauration du cache (plus rapide que npm install)
      - uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-

      # Adapter cette commande si le test unitaire se fait dans un sous-dossier spécifique.
      - run: npm run test:coverage --prefix packages/server

      - uses: actions/upload-artifact@v4
        with:
          name: coverage-artifact
          path: ./packages/server/coverage
          retention-days: 1

  # 4. Vérification du taux de couverture (uniquement sur les Pull Requests)
  coverage:
    name: Coverage check (PR only)
    needs: test-unit
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: coverage-artifact
          path: ./pr-coverage
      - name: Check coverage >= 80%
        run: |
          node -e '
          const fs = require("fs");
          const path = "./pr-coverage/coverage-summary.json";
          if (!fs.existsSync(path)) { console.error("❌ coverage-summary.json not found"); process.exit(1); }
          const data = JSON.parse(fs.readFileSync(path, "utf8"));
          const pct = data.total.lines.pct;
          if (pct < 80) { console.error(`❌ Coverage ${pct}% is below 80%`); process.exit(1); }
          console.log("✅ Coverage threshold passed:", pct, "%");
          '

  # 5. Construction du projet (sur le client, selon le main)
  build:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            packages/server/node_modules
            packages/client/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-

      - name: Build project (Client)
        # Exécution du build sur packages/client (approche main)
        run: npm run build --prefix packages/client

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/
          retention-days: 1

  # 5. Scan de sécurité NPM
  security-scan-npm:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      - run: npm audit --audit-level=high --prefix packages/server || true # Le "|| true" permet de ne pas bloquer si des failles mineures existent
      - run: npm audit --audit-level=high --prefix packages/client || true

  # 6. Build Docker TEST & Scan Trivy (Sans Push)
  docker-security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image (No Push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./packages/server/Dockerfile
          push: false
          tags: todo-test:latest
          load: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: todo-test:latest
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

# 7. Notifications Discord success / failure
  notify:
    needs: [test, build, security-scan-npm]
    runs-on: ubuntu-latest
    if: always()
    env:
      REPO: ${{ github.repository }}
      REF: ${{ github.ref_name }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Send Success Notification
        if: ${{ job.status == 'success' && env.WEBHOOK != '' }}
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ env.WEBHOOK }}
          severity: info
          details: "✅ BUILD SUCCESSFUL - All checks passed."

      - name: Send Failure Notification
        if: ${{ job.status == 'failure' && env.WEBHOOK != '' }}
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ env.WEBHOOK }}
          severity: error
          details: "❌ BUILD FAILED - Please check the CI logs."
